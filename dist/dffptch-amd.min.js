define(function(){function n(n,r,t,f,e){return t={},n.map(function(n){for(e=1;(f=n.slice(0,e++))<=r;);t[r=f]=n}),t}var r={},t=Object,f=t.keys;return r.diff=function e(r,a){for(var i=f(r).sort(),o=f(a).sort(),u=f(n(i)),c={},m={},s={},p=[],d={},v=0,l=0;i[v]||o[l];){var h=i[v],b=u[v],j=o[l],k=r[h],y=a[j];if(h==j){if(t(k)===k&&t(y)===y){var O=e(k,y);f(O)&&(d[b]=O)}else k!==y&&(s[b]=y);v++,l++}else h>j||!h?(m[j]=y,l++):(p.push(b),v++)}return p[0]&&(c.d=p),f(m)[0]&&(c.a=m),f(s)[0]&&(c.m=s),f(d)[0]&&(c.r=d),c},r.patch=function a(r,t){var e=n(f(r).sort());f(t.a||{}).map(function(n){r[n]=t.a[n]}),f(t.m||{}).map(function(n){r[e[n]]=t.m[n]}),(t.d||[]).map(function(n){delete r[e[n]]}),f(t.r||{}).map(function(n){a(r[e[n]],t.r[n])})},r});